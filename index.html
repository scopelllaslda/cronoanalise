<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronoanálise</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 20px auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        h2, h3 {
            color: #3498db;
            margin-top: 0;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 18px;
            font-size: 16px;
            border: none;
            background-color: #bdc3c7;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 6px;
        }

        .tab-button.active {
            background-color: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 100px;
            font-weight: 600;
        }

        .form-group input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }

        .form-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .timer-container {
            text-align: center;
            margin: 30px 0;
        }

        #timer {
            font-size: 40px;
            font-weight: bold;
            color: #2c3e50;
            background: #ecf0f1;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .button-group button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }

        #inicio-btn {
            background-color: #2ecc71;
            color: white;
        }

        #conta-btn {
            background-color: #3498db;
            color: white;
        }

        #fim-btn {
            background-color: #e74c3c;
            color: white;
        }

        #finalizar-crono {
            background-color: #f39c12;
            color: white;
            display: none;
        }

        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .button-group button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        tfoot td {
            font-weight: bold;
            background-color: #ecf0f1;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filters button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filters button:hover {
            background-color: #2980b9;
        }

        .chart-container {
            margin: 30px 0;
            height: 300px;
        }

        #video-container {
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        #video-preview {
            max-width: 100%;
            max-height: 300px;
            background-color: #000;
            border-radius: 4px;
        }

        .registros-section {
            margin-top: 30px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .not-supported {
            color: #e74c3c;
            font-size: 0.8em;
        }

        /* Novos estilos adicionados */
        .expand-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #3498db;
            padding: 5px;
        }

        .details-row {
            display: none;
        }

        .details-row.show {
            display: table-row;
        }

        .details-cell {
            padding: 10px 15px;
            background-color: #f8f9fa;
        }

        .details-content {
            padding: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .export-btn {
            padding: 8px 15px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .export-btn:hover {
            background-color: #219653;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .details-table th {
            background-color: #2980b9;
            padding: 8px 12px;
        }

        .details-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }

        .details-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* Estilos para a aba de Backup */
        .backup-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .backup-card {
            flex: 1;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .backup-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .backup-btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        #exportar-backup {
            background-color: #2ecc71;
            color: white;
        }

        #importar-backup {
            background-color: #3498db;
            color: white;
        }

        #file-input {
            display: none;
        }

        /* Ajuste para o checkbox de vídeo */
        .video-checkbox-label {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .video-checkbox-label input {
            margin-right: 10px;
        }

        /* Linha de total */
        .total-row td {
            font-weight: bold;
            background-color: #e3f2fd;
        }

        /* Modal de confirmação */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .confirm-btn {
            background-color: #2ecc71;
            color: white;
        }

        .cancel-btn {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Software de Cronoanálise</h1>
        
        <div class="tabs">
            <button class="tab-button active" data-target="analise">Cronoanálise</button>
            <button class="tab-button" data-target="historico">Histórico Completo</button>
            <button class="tab-button" data-target="backup">Backup</button>
        </div>
        
        <div id="analise" class="tab-content active">
            <h2>Cronoanálise</h2>
            <div class="form-group">
                <label for="item">Item:</label>
                <input type="text" id="item" required>
            </div>
            <div class="form-group">
                <label for="operacao">Operação:</label>
                <input type="text" id="operacao" required>
            </div>
            <div class="form-group">
                <label class="video-checkbox-label">
                    <input type="checkbox" id="gravar-video"> Gravar vídeo do processo
                </label>
            </div>
            
            <div class="timer-container">
                <div id="timer">00:00:00.000</div>
                <div class="button-group">
                    <button id="inicio-btn"><i class="fas fa-play"></i></button>
                    <button id="conta-btn" disabled><i class="fas fa-stopwatch"></i></button>
                    <button id="fim-btn" disabled><i class="fas fa-stop"></i></button>
                    <button id="finalizar-crono" style="display: none;">FINALIZAR CRONOANÁLISE</button>
                </div>
            </div>
            
            <div class="registros-section">
                <h3>Registros Atuais</h3>
                <table id="registros-atuais">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Operação</th>
                            <th>Tempo (seg)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2">Média:</td>
                            <td id="media-tempo">-</td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="2">Total:</td>
                            <td id="total-tempo">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div id="video-container">
                <video id="video-preview" controls></video>
            </div>
        </div>
        
        <div id="historico" class="tab-content">
            <h2>Histórico Completo</h2>
            <div class="filters">
                <select id="filtro-periodo">
                    <option value="dia">Dia</option>
                    <option value="mes">Mês</option>
                    <option value="ano">Ano</option>
                </select>
                <input type="text" id="filter-item" placeholder="Filtrar por item...">
                <input type="text" id="filter-operacao" placeholder="Filtrar por operação...">
                <button id="filtrar-btn">Filtrar</button>
                <button class="export-btn" id="exportar-excel-btn">
                    <i class="fas fa-file-excel"></i> EXPORTAR EXCEL
                </button>
            </div>
            
            <div class="chart-container">
                <canvas id="historico-chart"></canvas>
            </div>
            
            <table id="tabela-historico">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Operação</th>
                        <th>Tempo Médio (seg)</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="backup" class="tab-content">
            <h2>Backup de Dados</h2>
            <div class="backup-container">
                <div class="backup-card">
                    <h3>Exportar Backup</h3>
                    <p>Exporte todos os dados do sistema para um arquivo de backup</p>
                    <button id="exportar-backup" class="backup-btn">
                        <i class="fas fa-download"></i> EXPORTAR BACKUP
                    </button>
                </div>
                <div class="backup-card">
                    <h3>Importar Backup</h3>
                    <p>Importe um arquivo de backup para restaurar os dados</p>
                    <button id="importar-backup" class="backup-btn">
                        <i class="fas fa-upload"></i> IMPORTAR BACKUP
                    </button>
                    <input type="file" id="file-input" accept=".txt">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação para continuar cronômetro -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3>Continuar cronômetro?</h3>
            <p>Deseja continuar o cronômetro de onde parou?</p>
            <div class="modal-buttons">
                <button id="confirm-continue" class="confirm-btn">Continuar</button>
                <button id="cancel-continue" class="cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let cronometroAtivo = false;
        let inicioTempo;
        let tempoPausado = 0;
        let intervalo;
        let registrosAtuais = [];
        let historicoCompleto = [];
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let ultimoTempoContagem = 0;
        let historicoChart = null;
        let tempoAcumulado = 0; // Para armazenar o tempo quando pausado

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Configura estado inicial dos botões
            document.getElementById('conta-btn').disabled = true;
            document.getElementById('fim-btn').disabled = true;
            document.getElementById('finalizar-crono').style.display = 'none';

            // Configura eventos de clique
            configurarEventos();

            // Carrega dados salvos
            carregarDados();
            
            // Verifica suporte para gravação de vídeo
            const gravarVideoCheckbox = document.getElementById('gravar-video');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                gravarVideoCheckbox.disabled = true;
                gravarVideoCheckbox.parentNode.innerHTML += ' <span class="not-supported">(Não suportado)</span>';
            }
        });

        function configurarEventos() {
            // Eventos das abas
            document.querySelectorAll('.tab-button').forEach(botao => {
                botao.addEventListener('click', function() {
                    trocarAba(this.dataset.target);
                });
            });

            // Eventos do cronômetro
            document.getElementById('inicio-btn').addEventListener('click', iniciarCronometro);
            document.getElementById('conta-btn').addEventListener('click', registrarContagem);
            document.getElementById('fim-btn').addEventListener('click', finalizarCronometro);
            document.getElementById('finalizar-crono').addEventListener('click', finalizarCronoanalyse);
            
            // Evento do checkbox de vídeo
            document.getElementById('gravar-video').addEventListener('change', toggleVideo);
            
            // Eventos do histórico
            document.getElementById('filtrar-btn').addEventListener('click', filterHistorico);
            document.getElementById('exportar-excel-btn').addEventListener('click', exportarParaExcel);
            
            // Eventos de backup
            document.getElementById('exportar-backup').addEventListener('click', exportarBackup);
            document.getElementById('importar-backup').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', function() {
                importarBackup(this);
            });

            // Eventos do modal
            document.getElementById('confirm-continue').addEventListener('click', function() {
                document.getElementById('confirm-modal').style.display = 'none';
                continuarCronometro();
            });

            document.getElementById('cancel-continue').addEventListener('click', function() {
                document.getElementById('confirm-modal').style.display = 'none';
                reiniciarCronometro();
            });
        }

        // Função para trocar de aba
        function trocarAba(abaId) {
            // Remove a classe active de todas as abas e botões
            document.querySelectorAll(".tab-content").forEach(content => {
                content.classList.remove("active");
            });
            document.querySelectorAll(".tab-button").forEach(btn => {
                btn.classList.remove("active");
            });
            
            // Adiciona a classe active na aba e botão clicados
            document.getElementById(abaId).classList.add("active");
            document.querySelector(`.tab-button[data-target="${abaId}"]`).classList.add("active");

            if (abaId === 'historico') {
                atualizarGraficoHistorico();
            }
        }

        // Função para ligar/desligar a câmera
        function toggleVideo() {
            const gravarVideo = document.getElementById('gravar-video').checked;
            const videoContainer = document.getElementById('video-container');
            
            if (gravarVideo) {
                iniciarGravacao().then(() => {
                    videoContainer.style.display = 'block';
                }).catch(error => {
                    console.error('Erro ao iniciar gravação:', error);
                    document.getElementById('gravar-video').checked = false;
                    videoContainer.style.display = 'none';
                });
            } else {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                videoContainer.style.display = 'none';
            }
        }

        // Função para iniciar o cronômetro
        function iniciarCronometro() {
            const item = document.getElementById('item').value.trim();
            const operacao = document.getElementById('operacao').value.trim();

            if (!item || !operacao) {
                alert('Por favor, preencha o Item e a Operação antes de iniciar.');
                return;
            }

            // Verifica se já existe um cronômetro pausado
            if (tempoAcumulado > 0) {
                document.getElementById('confirm-modal').style.display = 'block';
                return;
            }

            // Iniciar cronômetro normalmente
            cronometroAtivo = true;
            inicioTempo = Date.now() - tempoAcumulado;
            ultimoTempoContagem = inicioTempo;
            registrosAtuais = [];
            atualizarRegistrosTabela();

            document.getElementById('inicio-btn').disabled = true;
            document.getElementById('conta-btn').disabled = false;
            document.getElementById('fim-btn').disabled = false;
            document.getElementById('finalizar-crono').style.display = 'none';

            // Desabilita edição dos campos durante a cronoanálise
            document.getElementById('item').disabled = true;
            document.getElementById('operacao').disabled = true;
            document.getElementById('gravar-video').disabled = true;

            intervalo = setInterval(atualizarCronometro, 10);
        }

        // Função para continuar o cronômetro de onde parou
        function continuarCronometro() {
            cronometroAtivo = true;
            inicioTempo = Date.now() - tempoAcumulado;
            ultimoTempoContagem = Date.now();

            document.getElementById('inicio-btn').disabled = true;
            document.getElementById('conta-btn').disabled = false;
            document.getElementById('fim-btn').disabled = false;
            document.getElementById('finalizar-crono').style.display = 'none';

            intervalo = setInterval(atualizarCronometro, 10);
        }

        // Função para reiniciar o cronômetro
        function reiniciarCronometro() {
            tempoAcumulado = 0;
            document.getElementById('timer').textContent = '00:00:00.000';
        }

        function atualizarCronometro() {
            if (!cronometroAtivo) return;

            const tempoAtual = Date.now();
            const tempoDecorrido = tempoAtual - inicioTempo;
            
            const horas = Math.floor(tempoDecorrido / 3600000);
            const minutos = Math.floor((tempoDecorrido % 3600000) / 60000);
            const segundos = Math.floor((tempoDecorrido % 60000) / 1000);
            const milissegundos = tempoDecorrido % 1000;
            
            document.getElementById('timer').textContent = 
                `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}.${milissegundos.toString().padStart(3, '0')}`;
        }

        function registrarContagem() {
            if (!cronometroAtivo) return;

            const tempoAtual = Date.now();
            const tempoDecorrido = (tempoAtual - ultimoTempoContagem) / 1000; // em segundos
            ultimoTempoContagem = tempoAtual;

            const item = document.getElementById('item').value;
            const operacao = document.getElementById('operacao').value;

            registrosAtuais.push({
                item: item,
                operacao: operacao,
                tempo: tempoDecorrido,
                data: new Date().toISOString(),
                hora: new Date().toLocaleTimeString()
            });

            atualizarRegistrosTabela();
        }

        function finalizarCronometro() {
            if (!cronometroAtivo) return;

            // Registra o tempo final
            const tempoAtual = Date.now();
            const tempoDecorrido = (tempoAtual - ultimoTempoContagem) / 1000; // em segundos
            
            const item = document.getElementById('item').value;
            const operacao = document.getElementById('operacao').value;

            registrosAtuais.push({
                item: item,
                operacao: operacao,
                tempo: tempoDecorrido,
                data: new Date().toISOString(),
                hora: new Date().toLocaleTimeString()
            });

            atualizarRegistrosTabela();

            // Para o cronômetro
            cronometroAtivo = false;
            tempoAcumulado = Date.now() - inicioTempo;
            clearInterval(intervalo);

            // Atualiza interface
            document.getElementById('inicio-btn').disabled = false;
            document.getElementById('conta-btn').disabled = true;
            document.getElementById('fim-btn').disabled = true;
            document.getElementById('finalizar-crono').style.display = 'inline-block';

            // Habilita edição dos campos
            document.getElementById('item').disabled = false;
            document.getElementById('operacao').disabled = false;
            document.getElementById('gravar-video').disabled = false;

            // Parar gravação de vídeo se estiver ativa
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function finalizarCronoanalyse() {
            if (registrosAtuais.length === 0) {
                alert("Nenhum registro para salvar!");
                return;
            }

            // Adiciona os registros atuais ao histórico completo
            historicoCompleto = historicoCompleto.concat(registrosAtuais);
            
            // Salvar dados
            salvarDados();
            
            // Resetar interface
            document.getElementById('item').value = '';
            document.getElementById('operacao').value = '';
            document.getElementById('timer').textContent = '00:00:00.000';
            document.getElementById('finalizar-crono').style.display = 'none';
            registrosAtuais = [];
            tempoAcumulado = 0;
            atualizarRegistrosTabela();

            alert("Cronoanálise finalizada e salva!");

            // Atualizar histórico se estiver na aba
            if (document.getElementById('historico').classList.contains('active')) {
                atualizarGraficoHistorico();
            }
        }

        // Funções auxiliares
        function atualizarRegistrosTabela() {
            const tbody = document.querySelector('#registros-atuais tbody');
            tbody.innerHTML = '';

            registrosAtuais.forEach(registro => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${registro.item}</td>
                    <td>${registro.operacao}</td>
                    <td>${registro.tempo.toFixed(3)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Atualiza média
            const media = registrosAtuais.length > 0 ? 
                (registrosAtuais.reduce((total, reg) => total + reg.tempo, 0) / registrosAtuais.length).toFixed(3) : 
                '-';
            document.getElementById('media-tempo').textContent = media;
            
            // Atualiza total
            const total = registrosAtuais.length > 0 ? 
                registrosAtuais.reduce((total, reg) => total + reg.tempo, 0).toFixed(3) : 
                '-';
            document.getElementById('total-tempo').textContent = total;
        }

        async function iniciarGravacao() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                const videoPreview = document.getElementById('video-preview');
                videoPreview.srcObject = mediaStream;
                videoPreview.play();

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(mediaStream);

                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    // Cria link para download do vídeo
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cronoanalise_${document.getElementById('item').value}_${new Date().toISOString().slice(0, 10)}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Limpeza
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        mediaStream.getTracks().forEach(track => track.stop());
                    }, 100);
                };

                // Não inicia a gravação imediatamente, só quando o botão de início for clicado
                return Promise.resolve();
            } catch (err) {
                console.error('Erro ao acessar a câmera:', err);
                alert('Erro ao acessar a câmera. Verifique as permissões.');
                document.getElementById('gravar-video').checked = false;
                return Promise.reject(err);
            }
        }

        function salvarDados() {
            const dadosParaSalvar = {
                historico: historicoCompleto,
                dataBackup: new Date().toISOString()
            };
            localStorage.setItem('cronoanalise_historico', JSON.stringify(dadosParaSalvar));
        }

        function carregarDados() {
            const dadosSalvos = localStorage.getItem('cronoanalise_historico');
            if (dadosSalvos) {
                const dados = JSON.parse(dadosSalvos);
                historicoCompleto = dados.historico || [];
            }
        }

        function atualizarHistorico() {
            const tbody = document.querySelector('#tabela-historico tbody');
            tbody.innerHTML = '';

            const historicoAgrupado = {};
            const periodo = document.getElementById('filtro-periodo').value;

            // Agrupa registros por item, operação e período
            historicoCompleto.forEach(registro => {
                const dataRegistro = new Date(registro.data);
                let chavePeriodo;

                if (periodo === 'dia') {
                    chavePeriodo = dataRegistro.toLocaleDateString();
                } else if (periodo === 'mes') {
                    chavePeriodo = `${dataRegistro.getMonth() + 1}/${dataRegistro.getFullYear()}`;
                } else {
                    chavePeriodo = dataRegistro.getFullYear().toString();
                }

                const key = `${registro.item}-${registro.operacao}-${chavePeriodo}`;
                if (!historicoAgrupado[key]) {
                    historicoAgrupado[key] = {
                        item: registro.item,
                        operacao: registro.operacao,
                        tempos: [],
                        registros: [],
                        data: chavePeriodo
                    };
                }
                historicoAgrupado[key].tempos.push(registro.tempo);
                historicoAgrupado[key].registros.push(registro);
            });

            // Preenche a tabela com os dados agrupados
            for (const key in historicoAgrupado) {
                const item = historicoAgrupado[key];
                const media = item.tempos.reduce((a, b) => a + b, 0) / item.tempos.length;
                
                // Linha principal
                const tr = document.createElement('tr');
                tr.className = 'main-row';
                tr.innerHTML = `
                    <td>${item.item}</td>
                    <td>${item.operacao}</td>
                    <td>${media.toFixed(3)}</td>
                    <td>${item.data}</td>
                    <td><button class="expand-button"><i class="fas fa-chevron-down"></i></button></td>
                `;
                tbody.appendChild(tr);

                // Linha de detalhes
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row';
                const detailsCell = document.createElement('td');
                detailsCell.colSpan = 5;
                detailsCell.className = 'details-cell';
                
                // Conteúdo dos detalhes
                const detailsContent = document.createElement('div');
                detailsContent.className = 'details-content';
                
                // Cria tabela de detalhes
                const detailsTable = document.createElement('table');
                detailsTable.className = 'details-table';
                detailsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tempo (seg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${item.registros.map(reg => `
                            <tr>
                                <td>${new Date(reg.data).toLocaleString()}</td>
                                <td>${reg.tempo.toFixed(3)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                detailsContent.appendChild(detailsTable);
                detailsCell.appendChild(detailsContent);
                detailsRow.appendChild(detailsCell);
                tbody.appendChild(detailsRow);
            }

            // Configura eventos dos botões de expansão
            document.querySelectorAll('.expand-button').forEach(botao => {
                botao.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const detailsRow = row.nextElementSibling;
                    const icon = this.querySelector('i');
                    
                    detailsRow.classList.toggle('show');
                    
                    if (detailsRow.classList.contains('show')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                });
            });

            return historicoAgrupado;
        }

        // Função para exportar para Excel (CSV)
        function exportarParaExcel() {
            // Obtém todos os registros do histórico
            let csvContent = "Item,Operação,Tempo (seg),Data,Hora\n";
            
            historicoCompleto.forEach(registro => {
                const data = new Date(registro.data);
                const dataFormatada = data.toLocaleDateString();
                const horaFormatada = data.toLocaleTimeString();
                
                csvContent += `"${registro.item}","${registro.operacao}",${registro.tempo.toFixed(3)},"${dataFormatada}","${horaFormatada}"\n`;
            });
            
            // Adiciona também os registros atuais (que ainda não foram salvos no histórico)
            registrosAtuais.forEach(registro => {
                const data = new Date(registro.data);
                const dataFormatada = data.toLocaleDateString();
                const horaFormatada = data.toLocaleTimeString();
                
                csvContent += `"${registro.item}","${registro.operacao}",${registro.tempo.toFixed(3)},"${dataFormatada}","${horaFormatada}"\n`;
            });
            
            // Cria link para download
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `historico_cronoanalise_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Função de filtro
        function filterHistorico() {
            const filterItem = document.getElementById('filter-item').value.toLowerCase();
            const filterOperacao = document.getElementById('filter-operacao').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabela-historico tbody tr.main-row');

            linhas.forEach(linha => {
                const item = linha.cells[0].textContent.toLowerCase();
                const operacao = linha.cells[1].textContent.toLowerCase();
                const shouldShow = (item.includes(filterItem) && operacao.includes(filterOperacao));
                
                linha.style.display = shouldShow ? '' : 'none';
                
                // Mostra/esconde a linha de detalhes correspondente
                const detailsRow = linha.nextElementSibling;
                if (detailsRow && detailsRow.classList.contains('details-row')) {
                    detailsRow.style.display = shouldShow ? '' : 'none';
                }
            });
        }

        // Funções de backup
        function exportarBackup() {
            const dadosParaExportar = {
                historico: historicoCompleto,
                dataBackup: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(dadosParaExportar, null, 2)], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_cronoanalise_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Backup exportado com sucesso!');
        }

        function importarBackup(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (dados.historico) {
                        historicoCompleto = dados.historico;
                        salvarDados();
                        alert('Backup importado com sucesso!');
                        
                        // Atualiza a interface se estiver na aba de histórico
                        if (document.getElementById('historico').classList.contains('active')) {
                            atualizarGraficoHistorico();
                        }
                    } else {
                        alert('Arquivo de backup inválido!');
                    }
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    alert('Erro ao importar backup. O arquivo pode estar corrompido.');
                }
            };
            reader.readAsText(file);
            
            // Limpa o input para permitir nova seleção do mesmo arquivo
            input.value = '';
        }

        function atualizarGraficoHistorico() {
            const historicoAgrupado = atualizarHistorico();
            const ctx = document.getElementById('historico-chart').getContext('2d');

            // Prepara dados para o gráfico
            const labels = [];
            const dados = [];

            // Ordena por data (mais recente primeiro)
            const itensOrdenados = Object.values(historicoAgrupado).sort((a, b) => {
                return new Date(b.data) - new Date(a.data);
            });

            // Limita a 10 itens para o gráfico não ficar poluído
            const itensParaGrafico = itensOrdenados.slice(0, 10);

            itensParaGrafico.forEach(item => {
                labels.push(`${item.item} - ${item.operacao} (${item.data})`);
                dados.push(item.tempos.length);
            });

            // Destrói gráfico anterior se existir
            if (historicoChart) {
                historicoChart.destroy();
            }

            // Cria novo gráfico
            historicoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de Cronoanálises',
                        data: dados,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Item - Operação (Período)'
                            }
                        }
                    }
                }
            });
        }

        // Inicialização dos eventos - Corrigindo os problemas de escopo
        document.addEventListener('DOMContentLoaded', function() {
            // Configura estado inicial dos botões
            document.getElementById('conta-btn').disabled = true;
            document.getElementById('fim-btn').disabled = true;
            document.getElementById('finalizar-crono').style.display = 'none';

            // Carrega dados salvos
            carregarDados();
            
            // Configura eventos dos botões
            document.getElementById('inicio-btn').addEventListener('click', iniciarCronometro);
            document.getElementById('conta-btn').addEventListener('click', registrarContagem);
            document.getElementById('fim-btn').addEventListener('click', finalizarCronometro);
            document.getElementById('finalizar-crono').addEventListener('click', finalizarCronoanalyse);
            
            // Configura eventos das abas
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const aba = this.getAttribute('data-target');
                    trocarAba(aba);
                });
            });
            
            // Verifica suporte para gravação de vídeo
            const gravarVideoCheckbox = document.getElementById('gravar-video');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                gravarVideoCheckbox.disabled = true;
                gravarVideoCheckbox.parentNode.innerHTML += ' <span class="not-supported">(Não suportado)</span>';
            } else {
                gravarVideoCheckbox.addEventListener('change', toggleVideo);
            }
        });

        // Garantindo que todas as funções estão no escopo global
        window.iniciarCronometro = iniciarCronometro;
        window.registrarContagem = registrarContagem;
        window.finalizarCronometro = finalizarCronometro;
        window.finalizarCronoanalyse = finalizarCronoanalyse;
        window.trocarAba = trocarAba;
        window.filterHistorico = filterHistorico;
        window.exportarParaExcel = exportarParaExcel;
        window.toggleVideo = toggleVideo;
    </script>
</body>
</html>